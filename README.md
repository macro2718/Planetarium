# Planetarium

Three.js を使って星空をリアルタイム描画するデータ駆動型プラネタリウムです。恒星・星座のカタログを JSON 風オブジェクトとして管理し、構造化データを追加するだけで 3D シーンに反映されます。ライブ観測、歴史イベントの再生、星座図書室、撮影アルバムなど複数の体験を 1 つのページにまとめています。

## できること
- **データ駆動**: `data/stars.js` / `data/constellations.js` / `astroCatalog.js` を編集するだけで星空が更新され、ランタイム API からも登録可能。
- **多層ビジュアル**: ミルキーウェイ、星座線、流星群、太陽・月・惑星、オーロラ、星の軌跡、レンズフレアなどを個別に ON/OFF。
- **時間と場所を操る**: リアルタイム同期・任意日時のタイムワープ（倍率指定）・固定時刻で日付だけを進める 3 モード。世界各地のプリセット観測地と地表タイプの切り替え付き。
- **3 つのモード**: ライブ観測 / Chrono Sky（歴史イベントアーカイブ） / 星の図書室（観測した星座のコレクション）。
- **撮影アルバム**: ワンクリックで WebGL フレームを保存し、フィルター（オーロラ・トワイライト・モノクロ等）やダウンロード、ローカル保存された写真の閲覧が可能。
- **操作性**: OrbitControls による視点操作と、画面右側のコントロールパネルでレンダリング要素や時間・音楽・自動回転をトグル。

## 起動方法
1. 依存ライブラリを取得します（`three` を npm で管理）。
   ```bash
   npm install
   ```
2. シンプルな静的サーバーを立ち上げます（ES Modules を扱うため file:// では動作しません）。
   ```bash
   npx http-server -p 8080 .
   ```
3. ブラウザで `http://localhost:8080` を開きます。

> 静的サーバーは `python -m http.server 8080` などでも構いません。

## 体験フロー
- ホームの「星空を見る」からモードを選択。
- **ライブ観測**: 世界のロケーションカードと地球儀から観測地点を選び、星空を操作。
- **Chrono Sky**: 年代順のイベントカードとタイムラインから歴史的な天文現象を再生（場所と時刻を自動セット、効果パネル付き）。
- **星の図書室**: 観測中にクリックした星座をコレクション化し、物語や季節情報を閲覧。
- **フォトアルバム**: ホームまたはプラネタリウム内のカメラボタンから撮影し、フィルターを適用して保存/ダウンロード。

## ライブ観測での操作
- 画面ドラッグで視点回転、ホイールでズーム。`自動回転` を有効化すると周回視点に。
- 右パネルのトグルでミルキーウェイ・星座線・流星・太陽/月・オーロラ・星軌跡・レンズフレア・各種基準線（赤経/赤緯、天の赤道、黄道、銀河赤道、月軌道）などを表示切替。
- `音楽` ボタンで BGM を再生/停止。
- 地表ボタンで水面/草原/砂漠/氷原などのサーフェス表現を変更。
- **時間モード**
  - `リアルタイム`: PC の現在時刻と同期。
  - `カスタム`: 任意日時を設定し、時間の倍率（逆行や停止も可）を指定。
  - `固定時刻`: 指定時刻を維持したまま日付だけを日送り/逆送り（倍率指定）。
- 星や惑星をクリックすると名称や等級を表示し、星座を発見すると図書室に記録されます。

## データを追加する
### 恒星を追加
1. `data/stars.js` の `BASE_STAR_DATA` 配列にオブジェクトを追加。
2. 必須: `id`, `name`, `ra`(赤経), `dec`(赤緯)。
3. 任意: `info`, `magnitude`, `color`, `glowColor`, `featured`, `distance`, `spectralType`, `temperature` など（未指定は `AstroCatalog` が補完）。
4. 保存後にブラウザをリロードするとクリック情報や星座描画へ自動反映されます。

### 星座を追加
1. `data/constellations.js` の `BASE_CONSTELLATION_DATA` にオブジェクトを追加。
2. 必須: `id` か `name` のいずれか、`starIds`（恒星 ID の配列）、`lines`（`[startId, endId]` の配列）。
3. `stars` プロパティで星データをインライン登録すると、同時にカタログへ編入されます。
4. `color` や `description` で線色・解説を付けられます。

### ランタイムで登録
- `AstroCatalog.registerStar(starDefinition)`
- `AstroCatalog.registerConstellation(constellationDefinition)`

`AstroCatalog.createDefault()` を呼び出せば、ベースデータを読み込んだカタログが生成されます。`planetarium.js` でも同処理を使っているため、データ編集だけで新しい星空を拡張できます。

## テスト
- 天文計算の一部を検証するユニットテスト:  
  ```bash
  npm test
  ```

## ディレクトリの目安
- `planetarium.js`: シーン初期化と各描画システムの統合、時間・観測地・BGM 管理。
- `astroCatalog.js`: 恒星・星座データを管理する `AstroCatalog` クラスと登録 API。
- `systems/`: 星雲、流星、星座線、太陽/月/惑星、オーロラ、星軌跡などのレンダリングシステム。
- `ui/`: ホーム/モード選択、観測地セレクタ、イベントアーカイブ、図書室、撮影アルバム、時間・表示トグル UI。
- `data/`: 恒星/星座カタログ、観測地プリセット、歴史イベント、星座物語などの構造化データ。
- `scripts/`: 星データ整備用の補助スクリプト。

## ライセンス
MIT
